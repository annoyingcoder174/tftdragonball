<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Dragon Ball Sparkling Zero - Trang chính</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/favicon.png" type="image/png">
    <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script defer src="scripts/firebaseConfig.js"></script>
    <script defer src="scripts/main.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1>Dragon Ball Sparkling Zero!</h1>

        <div class="controls">
            <label for="display-name">Tên hiển thị:</label>
            <input type="text" id="display-name" placeholder="Nhập tên của bạn">
            <button id="join-table-btn" onclick="joinTable()">📝 Tham gia bảng đấu</button>
            <button onclick="location.href='stats.html'">📊 Xem thống kê</button>
            <button id="leave-table-btn" style="display:none;" onclick="leaveTable()">🚪 Rời bảng</button>
        </div>

        <div id="post-join-buttons" style="display: none;" class="button-group">
            <button onclick="handleRollAugment()">🎲 Đổi lõi sức mạnh</button>
            <button onclick="handleRollChamp()">👊 Đổi tướng</button>
            <button onclick="resetShopUsage()">🛒 Đi Chợ</button>
            <button onclick="location.href='roll.html'">🎲 Máy Quay Toàn Năng</button>
        </div>


        <h2>Bảng đấu hiện tại</h2>
        <!-- Omni Calculator Button -->
        <button id="omniToggleBtn" style="position: fixed; bottom: 90px; right: 20px; z-index: 9999;">
            📊 Omni Calculator
        </button>

        <!-- Omni Calculator Modal -->
        <div id="omniModal"
            style="display: none; position: fixed; bottom: 150px; right: 20px; background: #111; color: #fff; padding: 20px; border: 2px solid #00ffcc; border-radius: 10px; z-index: 9999; width: 300px; font-family: sans-serif;">
            <h3>Máy Tính Vạn Năng</h3>
            <label>Vòng đấu: <input type="number" id="omniRound" min="1" /></label><br>
            <label>Vàng: <input type="number" id="omniGold" /></label><br>
            <label>Kinh nghiệm: <input type="number" id="omniExp" /></label><br>
            <label>Điểm sinh mệnh: <input type="number" id="omniHP" /></label><br>
            <label>+ Điểm sinh mệnh:</label>
            <input type="number" id="omniHPBonus" value="0" min="0" style="width: 80px;"><br>
            <label>Chuỗi thắng: <input type="number" id="omniWin" min="0" /></label><br>
            <label>Chuỗi thua: <input type="number" id="omniLose" min="0" /></label><br>
            <label>Khoảng cách tướng (nếu thua): <input type="number" id="omniGap" min="0" /></label><br><br>
            <button onclick="calculateOmni()">🧠 Tính</button>
            <div id="omniResult" style="margin-top: 10px; font-size: 14px;"></div>
        </div>


        <table id="augment-table">
            <h3>Môi trường</h3>
            <div id="environment-display">Đang tải...</div>

            <thead>
                <tr>
                    <th>Người chơi</th>
                    <th>Lõi đã chọn</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button onclick="location.href='history.html'">📜 Xem lịch sử</button>
        <h2>Bảng đã tham gia</h2>
        <div id="previous-tables">Đang tải...</div>
    </div>


    <script>
        function handleRollAugment() {
            const user = firebase.auth().currentUser;
            if (user) {
                incrementAugmentRollCount(user.uid);
                location.href = 'rollAugment.html';
            }
        }

        function handleRollChamp() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const playerRef = firebase.firestore().collection("tables").doc("sharedTable").collection("players").doc(user.uid);

            // Clear level restrictions in Firestore
            playerRef.update({
                rollLevels: [], // Clear levels
                hasRolledOnce: false // Reset free roll status
            }).then(() => {
                console.log("🔄 Level restrictions and free rolls reset for user:", user.uid);
                // Clear local free roll tracking
                localStorage.removeItem("freeRollsUsed");
                sessionStorage.removeItem("freeRollsUsed");
                console.log("🔄 Free roll restrictions cleared locally");

                // Redirect to rollChamp.html
                location.href = "rollChamp.html";
            }).catch(error => {
                console.error("❌ Error resetting levels:", error);
            });
        }



    </script>
</body>

</html>